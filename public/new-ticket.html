<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Yeni Talep</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootswatch (Lux) + Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/lux/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root{
      --brand-1:#7A3DFC; /* violet */
      --brand-2:#00E5FF; /* cyan */
      --brand-3:#E429E8; /* magenta */
      --ink:#0f172a;     /* deep text */
      --muted:#64748b;   /* slate */
      --bg:#f7f8fc;      /* page bg */
      --card:#ffffff;    /* card bg */
    }
    html,body{height:100%}
    body{background: radial-gradient(1200px 600px at 10% -10%, rgba(122,61,252,.08), transparent 60%),
                     radial-gradient(900px 500px at 90% 10%, rgba(0,229,255,.10), transparent 60%),
                     radial-gradient(800px 400px at 40% 110%, rgba(228,41,232,.08), transparent 60%),
                     var(--bg)!important;}

    /* NAVBAR */
    .navbar{backdrop-filter:saturate(150%) blur(8px); background:rgba(255,255,255,.7)!important; border-bottom:1px solid #e9edf5!important}
    .navbar-brand{font-weight:700; letter-spacing:.2px; color: var(--ink)!important}
    .btn-outline-light{border-color:#cbd5e1!important; color:#334155!important}
    .btn-outline-light:hover{background:#e2e8f0!important; color:#0f172a!important}

    /* HEADER RIBBON */
    .ribbon{border-radius:20px; border:1px solid rgba(0,0,0,.05); background:linear-gradient(135deg, rgba(122,61,252,.12), rgba(0,229,255,.12));}

    /* FORM CARD */
    .form-card{background:var(--card); border:1px solid #e9edf5; box-shadow:0 10px 30px rgba(2,6,23,.05); border-radius:18px}
    .form-label{color:var(--ink); font-weight:600}
    .text-muted{color:var(--muted)!important}

    /* CONTROLS */
    .form-control{border:1px solid #e2e8f0; background:#fff; border-radius:12px}
    .form-control:focus{border-color:#c7d2fe; box-shadow:0 0 0 .25rem rgba(122,61,252,.15)}
    .btn-primary{background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); border:0; box-shadow:0 8px 20px rgba(122,61,252,.25); border-radius:12px}
    .btn-primary:hover{filter:brightness(.95)}
    .btn-outline-secondary{border-color:#e2e8f0; color:#0f172a; border-radius:12px; background:#fff}
    .btn-outline-secondary:hover{background:#f1f5f9; color:#0f172a}

    /* SELECT CARDS (kategori seçim ızgarası) */
    .select-card{border:1px solid #e9edf5; border-radius:14px; padding:12px; cursor:pointer; background:#fff; transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease}
    .select-card:hover{transform:translateY(-2px); box-shadow:0 12px 28px rgba(2,6,23,.08)}
    .select-card.selected{border-color:#c7d2fe; box-shadow:0 0 0 .2rem rgba(122,61,252,.15)}

    /* FILE CHIP */
    .file-chip{display:inline-flex; gap:8px; align-items:center; background:#eef2ff; color:#4338ca; border:1px solid #c7d2fe; border-radius:999px; padding:6px 10px}
    .file-chip button{border:0; background:transparent; color:#4338ca}

    /* ALERT */
    .alert{border:none; border-radius:12px}
  </style>
</head>
<body>
  <nav class="navbar sticky-top">
    <div class="container-xxl d-flex align-items-center justify-content-between">
      <a class="navbar-brand d-inline-flex align-items-center gap-2" href="/user.html"><i class="bi bi-arrow-left"></i> HelpNest · Yeni Talep</a>
      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted" id="userInfo"></span>
        <a class="btn btn-outline-light btn-sm" href="/user.html">Panel</a>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <!-- Header ribbon -->
    <div class="ribbon p-3 p-md-4 mb-4">
      <h2 class="h5 mb-1">Yeni Talep Oluştur</h2>
      <div class="small text-muted">Konu ve açıklamayı yazın, gerekirse kategori ve görsel ekleyin.</div>
    </div>

    <div class="form-card p-3 p-md-4">
      <div id="alert" class="alert d-none" role="alert"></div>

      <form id="form" novalidate>
        <div class="mb-3">
          <label class="form-label">Konu <span class="text-danger">*</span></label>
          <input id="subject" class="form-control" required placeholder="Örn. Office uygulamalarımda sorun yaşıyorum" />
        </div>

        <div class="mb-3">
          <label class="form-label">Açıklama</label>
          <textarea id="description" class="form-control" rows="6" placeholder="Uygulamaya girişte yetki hatası alıyorum..."></textarea>
        </div>

        <!-- Görsel -->
        <div class="mb-3">
          <label class="form-label">Görsel Ekle (JPEG, opsiyonel)</label>
          <input id="file" type="file" accept="image/jpeg" class="form-control" />
          <div id="fileInfo" class="mt-2"></div>
        </div>

        <!-- Kategori / Alt Kategori / Sorun Türü -->
        <div class="mb-2 fw-semibold">Kategori Seçimi</div>
        <div id="catsRow" class="row g-3">
          <div class="col-md-4">
            <div class="select-card" id="catsCol">
              <div class="small text-muted">Yükleniyor…</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="select-card" id="subsCol">
              <div class="fw-semibold">Alt kategori</div>
              <div class="small text-muted">Önce kategori seçin</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="select-card" id="subsubsCol">
              <div class="fw-semibold">Sorun Türü</div>
              <div class="small text-muted">Önce alt kategori seçin</div>
            </div>
          </div>
        </div>

        <div class="mt-3 d-flex gap-2">
          <button id="btn" class="btn btn-primary"><i class="bi bi-send me-1"></i>Gönder</button>
          <a href="/user.html" class="btn btn-outline-secondary">İptal</a>
        </div>
      </form>
    </div>
  </main>

  <script>
    const $ = s => document.querySelector(s);
    let me = null;
    let selectedCat = null;     // {id,name}
    let selectedSub = null;     // {id,name}
    let selectedSubSub = null;  // {id,name}
    let chosenFile = null;

    // Oturum
    (async () => {
      const r = await fetch('/auth/me', { credentials:'include' });
      if (!r.ok) return window.location.href='/login.html';
      me = (await r.json()).user;
      $('#userInfo').textContent = `${me.full_name} • ${me.email}`;
      if (me.role !== 'end_user') { window.location.href='/dashboard.html'; return; }
      await loadCategories();
    })();

    // Dosya seçimi
    $('#file').addEventListener('change', e=>{
      const f = e.target.files[0];
      chosenFile = null; $('#fileInfo').innerHTML = '';
      if (!f) return;
      if (f.type !== 'image/jpeg') { showAlert('warning','Sadece JPEG dosyalar kabul edilir.'); e.target.value=''; return; }
      chosenFile = f;
      const chip = document.createElement('div');
      chip.className='file-chip mt-1';
      chip.innerHTML = `<i class="bi bi-paperclip"></i><span>${escapeHtml(f.name)}</span><button type="button" title="Kaldır"><i class="bi bi-trash3"></i></button>`;
      chip.querySelector('button').onclick = ()=>{ chosenFile=null; $('#file').value=''; chip.remove(); };
      $('#fileInfo').appendChild(chip);
    });

    // 1) Kategoriler
    async function loadCategories(){
      const r = await fetch('/tickets/categories', { credentials:'include' });
      let cats = [];
      if (r.ok) cats = await r.json();
      renderCategories(cats);
    }

    function renderCategories(cats){
      const col = $('#catsCol');
      col.innerHTML = cats.length
        ? cats.map(c=>`
            <div class="select-card mb-2" data-type="cat" data-id="${c.id}" data-name="${escapeHtml(c.name)}">
              ${escapeHtml(c.name)}
            </div>`).join('')
        : `<div class="small text-muted">Kategori bulunamadı (opsiyonel).</div>`;

      col.querySelectorAll('[data-type="cat"]').forEach(el=>{
        el.addEventListener('click', async ()=>{
          col.querySelectorAll('[data-type="cat"]').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          selectedCat = { id:Number(el.dataset.id), name:el.dataset.name };
          selectedSub = null; selectedSubSub = null;
          await loadSubcategories(selectedCat.id);
          resetSubSubCol();
        });
      });
    }

    // 2) Alt kategoriler
    async function loadSubcategories(categoryId){
      const holder = $('#subsCol');
      holder.innerHTML = '<div class="small text-muted">Yükleniyor…</div>';
      const r = await fetch('/tickets/subcategories?category_id='+categoryId, { credentials:'include' });
      const list = r.ok ? await r.json() : [];
      holder.className='select-card';
      holder.innerHTML = list.length
        ? list.map(sc=>`
            <div class="select-card mb-2" data-type="sub" data-id="${sc.id}" data-name="${escapeHtml(sc.name)}">
              ${escapeHtml(sc.name)}
            </div>`).join('')
        : '<div class="small text-muted">Alt kategori yok.</div>';

      holder.querySelectorAll('[data-type="sub"]').forEach(el=>{
        el.addEventListener('click', async ()=>{
          holder.querySelectorAll('[data-type="sub"]').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          selectedSub = { id:Number(el.dataset.id), name:el.dataset.name };
          selectedSubSub = null; await loadSubSubcategories(selectedSub.id);
        });
      });
    }

    function resetSubSubCol(){
      const box = $('#subsubsCol');
      box.innerHTML = `
        <div class="fw-semibold">Sorun Türü</div>
        <div class="small text-muted">Önce alt kategori seçin</div>
      `;
    }

    // 3) Alt-alt kategoriler (Sorun Türü)
    async function loadSubSubcategories(subcategoryId){
      const box = $('#subsubsCol');
      box.innerHTML = '<div class="small text-muted">Yükleniyor…</div>';
      const r = await fetch('/tickets/subsubcategories?subcategory_id='+subcategoryId, { credentials:'include' });
      const list = r.ok ? await r.json() : [];
      box.innerHTML = list.length
        ? list.map(ss=>`
            <div class="select-card mb-2" data-type="subsub" data-id="${ss.id}" data-name="${escapeHtml(ss.name)}">
              ${escapeHtml(ss.name)}
            </div>`).join('')
        : '<div class="small text-muted">Seçenek yok (opsiyonel).</div>';

      box.querySelectorAll('[data-type="subsub"]').forEach(el=>{
        el.addEventListener('click', ()=>{
          box.querySelectorAll('[data-type="subsub"]').forEach(x=>x.classList.remove('selected'));
          el.classList.add('selected');
          selectedSubSub = { id:Number(el.dataset.id), name:el.dataset.name };
        });
      });
    }

    // Form submit
    $('#form').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const subject = $('#subject').value.trim();
      if (!subject) return showAlert('danger','Konu zorunludur.');

      const payload = { subject, description: $('#description').value };
      if (selectedCat?.id)    payload.category_id = selectedCat.id;
      if (selectedSub?.id)    payload.subcategory_id = selectedSub.id;
      if (selectedSubSub?.id) payload.sub_subcategory_id = selectedSubSub.id; // 3. seviye

      // 1) ticket
      const r = await fetch('/tickets', { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body: JSON.stringify(payload) });
      if (!r.ok){ const t = await r.text(); return showAlert('danger','Talep oluşturulamadı: '+t); }
      const { id } = await r.json();

      // 2) jpeg varsa
      if (chosenFile){
        const fd = new FormData(); fd.append('file', chosenFile, chosenFile.name);
        const ur = await fetch(`/files/ticket/${id}`, { method:'POST', credentials:'include', body:fd });
        if (!ur.ok) showAlert('warning','Talep oluşturuldu, ancak görsel yüklenemedi.');
      }

      showAlert('success', `Talep #${id} oluşturuldu. Yönlendiriliyorsunuz…`);
      setTimeout(()=> window.location.href='/user.html', 700);
    });

    function showAlert(type, msg){ const a = $('#alert'); a.className = 'alert alert-'+type; a.textContent = msg; a.classList.remove('d-none'); }
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
  </script>
</body>
</html>
