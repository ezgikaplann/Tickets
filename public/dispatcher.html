<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Dispatcher Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootswatch (Lux) + Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/lux/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root{
      --brand-1:#7A3DFC; /* violet */
      --brand-2:#00E5FF; /* cyan */
      --brand-3:#E429E8; /* magenta */
      --ink:#0f172a;     /* deep text */
      --muted:#64748b;   /* slate */
      --bg:#f7f8fc;      /* page bg */
      --card:#ffffff;    /* card bg */
    }
    html,body{height:100%}
    body{background: radial-gradient(1200px 600px at 10% -10%, rgba(122,61,252,.08), transparent 60%),
                     radial-gradient(900px 500px at 90% 10%, rgba(0,229,255,.10), transparent 60%),
                     radial-gradient(800px 400px at 40% 110%, rgba(228,41,232,.08), transparent 60%),
                     var(--bg)!important;}

    /* NAVBAR */
    .navbar{backdrop-filter:saturate(150%) blur(8px); background:rgba(255,255,255,.7)!important; border-bottom:1px solid #e9edf5!important}
    .navbar-brand{font-weight:700; letter-spacing:.2px;}

    /* HEADER RIBBON */
    .ribbon{border-radius:20px; border:1px solid rgba(0,0,0,.05); background:linear-gradient(135deg, rgba(122,61,252,.12), rgba(0,229,255,.12));}

    /* CARDS */
    .ticket-card{background:var(--card); border:1px solid #e9edf5; border-left:6px solid transparent; box-shadow:0 10px 30px rgba(2,6,23,.05); transition:transform .18s ease, box-shadow .18s ease}
    .ticket-card:hover{transform:translateY(-3px); box-shadow:0 18px 40px rgba(2,6,23,.08)}
    .subject{color:var(--ink); font-weight:600}
    .excerpt{color:#475569}

    /* STATUS + PRIORITY */
    .status-pill{font-weight:600; padding:.35rem .6rem; border-radius:999px; border:1px solid #e2e8f0}
    .s-new{background:#eef2ff; color:#4338ca; border-color:#c7d2fe}
    .s-open{background:#fff7ed; color:#9a3412; border-color:#fed7aa}
    .s-assigned{background:#ecfeff; color:#0e7490; border-color:#a5f3fc}
    .s-resolved{background:#ecfdf5; color:#047857; border-color:#a7f3d0}
    .s-cancelled{background:#fff1f2; color:#be123c; border-color:#fecdd3}
    .s-closed{background:#f1f5f9; color:#334155; border-color:#e2e8f0}

    .priority-chip{padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700}
    .p-low{background:#f1f5f9; color:#334155}
    .p-medium{background:#fef3c7; color:#92400e}
    .p-high{background:#fee2e2; color:#991b1b}

    /* SEARCH */
    .search-wrap{position:relative}
    .search-wrap .bi{position:absolute; left:.75rem; top:50%; transform:translateY(-50%); color:#94a3b8}
    .search-wrap input{padding-left:2.2rem}

    /* CHAT BUBBLES */
    .bubble{max-width:78%; padding:.6rem .75rem; border-radius:16px; box-shadow:0 8px 20px rgba(2,6,23,.08)}
    .bubble-me{margin-left:auto; background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff}
    .bubble-other{background:#f8fafc; color:#0f172a; border:1px solid #e2e8f0}

    /* UTIL */
    .border-subtle{border:1px solid #e9edf5}
  </style>
</head>
<body>
  <nav class="navbar sticky-top">
    <div class="container-xxl">
      <a class="navbar-brand" href="#">HelpNest</a>
      <div class="d-flex align-items-center gap-2">
        <div class="small text-muted" id="userInfo"></div>
        <button id="btnLogout" class="btn btn-outline-secondary btn-sm">Çıkış</button>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <!-- Header / Filters -->
    <div class="ribbon p-3 p-md-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-4">
          <h2 class="h4 mb-1">Tüm Talepler</h2>
          <div class="text-muted small">Sistemdeki tüm talepleri görüntüleyin, filtreleyin ve atayın.</div>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Kategori</label>
          <select id="categorySelect" class="form-select">
            <option value="">Tüm Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Alt Kategori</label>
          <select id="subcategorySelect" class="form-select">
            <option value="">Tüm Alt Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Alt-Alt Kategori</label>
          <select id="subsubcategorySelect" class="form-select">
            <option value="">Tüm Alt-Alt Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-lg-2">
          <label class="form-label mb-1">Ara</label>
          <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input id="search" class="form-control" placeholder="Konu / açıklama ara (Enter)…" />
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Panel (inline) -->
    <div id="chatPanel" class="card border-subtle mb-3" style="display: none;">
      <div class="card-header bg-white border-subtle d-flex justify-content-between align-items-center">
        <h6 class="mb-0" id="chatTitle">Talep Detayı</h6>
        <button type="button" class="btn-close" id="closeChat"></button>
      </div>
      <div class="card-body p-0">
        <div class="p-3 border-bottom border-subtle">
          <h6 id="ticketSubject" class="mb-1">Konu</h6>
          <div class="small text-muted mb-2" id="ticketDescription">Açıklama</div>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <span id="ticketStatus" class="status-pill s-new">Yeni</span>
            <span id="ticketPriority" class="priority-chip p-medium">Orta</span>
          </div>
        </div>
        <div id="messageList" class="p-3" style="height: 320px; overflow-y:auto;">
          <div class="text-center text-muted"><small>Henüz mesaj yok</small></div>
        </div>
        <div class="p-3 border-top border-subtle">
          <div class="input-group">
            <input type="text" class="form-control" id="messageInput" placeholder="Mesaj yazın…" />
            <button class="btn btn-primary" type="button" id="sendMessage"><i class="bi bi-send"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Ticket List -->
    <div id="list" class="row g-3"></div>
    <div id="empty" class="text-muted text-center d-none py-5">
      <svg width="72" height="72" viewBox="0 0 24 24" fill="none" class="mb-2" xmlns="http://www.w3.org/2000/svg"><path d="M20 7H4v10h16V7Zm-5 7H9" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2" stroke="#94a3b8" stroke-width="1.5"/></svg>
      <div>Hiç talep bulunamadı.</div>
    </div>
  </main>

  <!-- Assign Modal -->
  <div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Bileti Ata</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Kullanıcı</label>
            <select id="assignUserSelect" class="form-select"></select>
            <div id="assignUsersFallback" class="form-text d-none">
              Kullanıcı listesi alınamadı. Backend'de <code>GET /users</code> etkin olmalı ve sadece <code>dispatcher</code> erişebilmeli.
            </div>
          </div>
          <div class="alert alert-warning d-none" id="assignWarn"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
          <button id="btnDoAssign" class="btn btn-primary">Ata</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Talebi Düzenle</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editTicketId">
          <div class="mb-3">
            <label class="form-label">Konu</label>
            <input type="text" class="form-control" id="editSubject" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Açıklama</label>
            <textarea class="form-control" id="editDescription" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label class="form-label">Öncelik</label>
            <select class="form-select" id="editPriority">
              <option value="LOW">Düşük</option>
              <option value="MEDIUM">Orta</option>
              <option value="HIGH">Yüksek</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
          <button id="btnSaveEdit" class="btn btn-primary">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    let me = null;
    let assignableUsers = [];
    let selectedTicketId = null;
    let selectedTicket = null;
    let messages = [];
    let categories = [];
    let subcategories = [];
    let subsubcategories = [];

    // Session + role guard
    (async () => {
      const r = await fetch('/auth/me', { credentials: 'include' });
      if (!r.ok) return window.location.href = '/login.html';
      me = (await r.json()).user;
      if (me.role !== 'dispatcher') {
        return window.location.href = (me.role === 'end_user') ? '/user.html' : '/dashboard.html';
      }
      $('#userInfo').textContent = `${me.full_name} • ${me.role}`;

      await loadCategories();

      try {
        const ur = await fetch('/users', { credentials: 'include' });
        if (!ur.ok) throw new Error();
        assignableUsers = await ur.json();
        $('#assignUserSelect').innerHTML = assignableUsers.map(u=>`<option value="${u.id}">${escapeHtml(u.full_name)}</option>`).join('');
      } catch { $('#assignUsersFallback').classList.remove('d-none'); }

      await loadInbox();
      bindAssignEvents();
    })();

    // Logout
    $('#btnLogout').addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch {}
      localStorage.removeItem('helpdesk_user'); window.location.href = '/login.html';
    });

    // Filters
    async function loadCategories(){
      try{
        const res = await fetch('/tickets/categories', { credentials: 'include' });
        if (res.ok){
          categories = await res.json();
          $('#categorySelect').innerHTML = '<option value="">Tüm Kategoriler</option>' + categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
        }
      }catch(e){ console.error('Kategoriler yüklenemedi:', e); }
    }

    async function loadSubcategories(categoryId){
      try{
        if (!categoryId){ $('#subcategorySelect').innerHTML = '<option value="">Tüm Alt Kategoriler</option>'; $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>'; return; }
        const res = await fetch(`/tickets/subcategories?category_id=${categoryId}`, { credentials: 'include' });
        if (res.ok){
          subcategories = await res.json();
          $('#subcategorySelect').innerHTML = '<option value="">Tüm Alt Kategoriler</option>' + subcategories.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }
        $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
      }catch(e){ console.error('Alt kategoriler yüklenemedi:', e); }
    }

    async function loadSubsubcategories(subcategoryId){
      try{
        if (!subcategoryId){ $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>'; return; }
        const res = await fetch(`/tickets/subsubcategories?subcategory_id=${subcategoryId}`, { credentials: 'include' });
        if (res.ok){
          subsubcategories = await res.json();
          $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>' + subsubcategories.map(s=>`<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        }
      }catch(e){ console.error('Alt-alt kategoriler yüklenemedi:', e); }
    }

    $('#categorySelect').addEventListener('change', async (e)=>{ await loadSubcategories(e.target.value); await loadInbox(); });
    $('#subcategorySelect').addEventListener('change', async (e)=>{ await loadSubsubcategories(e.target.value); await loadInbox(); });
    $('#subsubcategorySelect').addEventListener('change', async ()=>{ await loadInbox(); });

    // Search (debounce + enter)
    let searchTimeout;
    $('#search').addEventListener('input', async ()=>{ clearTimeout(searchTimeout); searchTimeout = setTimeout(loadInbox, 300); });
    $('#search').addEventListener('keydown', async (e)=>{ if (e.key === 'Enter'){ clearTimeout(searchTimeout); await loadInbox(); } });

    // Tickets fetch
    async function fetchTickets(params = {}){
      const qs = new URLSearchParams(params).toString();
      const r = await fetch('/tickets' + (qs ? `?${qs}` : ''), { credentials: 'include' });
      if (!r.ok) throw new Error('tickets failed');
      return r.json();
    }

    async function loadInbox(){
      const q = $('#search').value.trim();
      const categoryId = $('#categorySelect').value;
      const subcategoryId = $('#subcategorySelect').value;
      const subsubcategoryId = $('#subsubcategorySelect').value;
      const params = {};
      if (q) params.q = q;
      if (categoryId) params.category_id = categoryId;
      if (subcategoryId) params.subcategory_id = subcategoryId;
      if (subsubcategoryId) params.sub_subcategory_id = subsubcategoryId;

      const list = await fetchTickets(params);

      // Sort: unresolved -> resolved -> cancelled, with priority/date tie-breakers
      list.sort((a, b) => {
        if (a.status === 'CANCELLED' && b.status !== 'CANCELLED') return 1;
        if (a.status !== 'CANCELLED' && b.status === 'CANCELLED') return -1;
        if (a.status === 'CANCELLED' && b.status === 'CANCELLED') return new Date(b.created_at) - new Date(a.created_at);
        const aResolved = ['RESOLVED', 'CLOSED'].includes(a.status);
        const bResolved = ['RESOLVED', 'CLOSED'].includes(b.status);
        if (!aResolved && bResolved) return -1;
        if (aResolved && !bResolved) return 1;
        if (aResolved && bResolved) return new Date(b.created_at) - new Date(a.created_at);
        const prio = { HIGH:1, MEDIUM:2, LOW:3 };
        const d = (prio[a.priority]||2) - (prio[b.priority]||2);
        if (d !== 0) return d;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      render(list);
    }

    function render(list){
      const el = $('#list'), empty = $('#empty');
      if (!list.length){ el.innerHTML=''; empty.classList.remove('d-none'); return; }
      empty.classList.add('d-none');
      el.innerHTML = list.map(t => card(t)).join('');
    }

    function statusClass(s){
      switch(s){
        case 'NEW': return 's-new';
        case 'OPEN': return 's-open';
        case 'ASSIGNED': return 's-assigned';
        case 'RESOLVED': return 's-resolved';
        case 'CANCELLED': return 's-cancelled';
        case 'CLOSED': return 's-closed';
        default: return 's-closed';
      }
    }

    function statusText(s){
      return ({ NEW:'Yeni', OPEN:'Açık', ASSIGNED:'Atandı', RESOLVED:'Çözüldü', CANCELLED:'İptal', CLOSED:'Kapalı' }[s] || s);
    }

    function priorityChip(p){
      const cls = p==='HIGH' ? 'p-high' : p==='LOW' ? 'p-low' : 'p-medium';
      const text = p==='HIGH' ? 'Yüksek' : p==='LOW' ? 'Düşük' : 'Orta';
      return `<span class="priority-chip ${cls}">${text}</span>`
    }

    function cardBorder(s){
      return ({ NEW:'#7A3DFC', OPEN:'#FB923C', ASSIGNED:'#00B8D9', RESOLVED:'#22C55E', CANCELLED:'#EF4444', CLOSED:'#94A3B8' }[s] || '#94A3B8');
    }

    function card(t){
      const created = new Date(t.created_at).toLocaleString('tr-TR');
      const border = cardBorder(t.status);
      const isResolved = ['RESOLVED','CLOSED'].includes(t.status);

      const assignBtn = !isResolved && t.status !== 'CANCELLED' ? `<button class="btn btn-sm btn-primary btn-assign" data-id="${t.id}"><i class="bi bi-person-check"></i> Atama Yap</button>` : '';
      const cancelBtn = !isResolved && t.status !== 'CANCELLED' ? `<button class="btn btn-sm btn-warning btn-cancel ms-1" data-id="${t.id}"><i class="bi bi-x-circle"></i> İptal Et</button>` : '';
      const editBtn = !['CANCELLED','RESOLVED','CLOSED'].includes(t.status) ? `<button class="btn btn-sm btn-info btn-edit ms-1" data-id="${t.id}"><i class="bi bi-pencil"></i> Düzenle</button>` : '';
      const deleteBtn = `<button class="btn btn-sm btn-danger btn-delete ms-1" data-id="${t.id}"><i class="bi bi-trash"></i> Sil</button>`;
      const prioritySelect = (!isResolved && t.status !== 'CANCELLED') ? `
        <select class="form-select form-select-sm priority-select mt-2" data-id="${t.id}" style="width:auto;">
          <option value="LOW" ${t.priority==='LOW'?'selected':''}>Düşük</option>
          <option value="MEDIUM" ${t.priority==='MEDIUM'?'selected':''}>Orta</option>
          <option value="HIGH" ${t.priority==='HIGH'?'selected':''}>Yüksek</option>
        </select>` : '';

      return `
      <div class="col-12">
        <div class="ticket-card p-3 rounded-3" style="border-left-color:${border}" role="button">
          <div class="d-flex justify-content-between align-items-start gap-3">
            <div class="flex-grow-1" onclick="selectTicket(${Number(t.id)})">
              <div class="d-flex justify-content-between align-items-start">
                <div class="subject">${escapeHtml(t.subject||'(Konu yok)')}</div>
                <span class="status-pill ${statusClass(t.status)}">${statusText(t.status)}</span>
              </div>
              <div class="small text-muted mt-1">#${t.id} • ${created} • ${priorityChip(t.priority)}</div>
              <div class="excerpt small mt-2">${escapeHtml((t.description||'').slice(0,200))}</div>
              ${t.assignee_name ? `<div class="small mt-2 text-muted"><i class="bi bi-people"></i> ${escapeHtml(t.assignee_name)}</div>` : ''}
            </div>
            <div class="text-end">
              ${assignBtn}
              ${cancelBtn}
              ${editBtn}
              ${deleteBtn}
              ${prioritySelect}
            </div>
          </div>
        </div>
      </div>`;
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}

    // Delegated actions on list
    $('#list').addEventListener('click', async (e)=>{
      const btnAssign = e.target.closest('.btn-assign');
      if (btnAssign){ e.stopPropagation(); selectedTicketId = btnAssign.getAttribute('data-id'); $('#assignWarn').classList.add('d-none'); bootstrap.Modal.getOrCreateInstance('#assignModal').show(); return; }
      const btnCancel = e.target.closest('.btn-cancel');
      if (btnCancel){ e.stopPropagation(); const id = btnCancel.getAttribute('data-id'); if(!confirm('Bu talebi iptal etmek istediğinizden emin misiniz?')) return; try{ const res = await fetch(`/tickets/${id}/cancel`, { method:'PUT', credentials:'include' }); if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error||`HTTP ${res.status}`);} await loadInbox(); }catch(err){ alert('Talep iptal edilemedi: '+err.message);} return; }
      const btnEdit = e.target.closest('.btn-edit');
      if (btnEdit){ e.stopPropagation(); await openEditModal(btnEdit.getAttribute('data-id')); return; }
      const btnDelete = e.target.closest('.btn-delete');
      if (btnDelete){ e.stopPropagation(); const id = btnDelete.getAttribute('data-id'); if(!confirm('Bu talebi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!')) return; try{ const res = await fetch(`/tickets/${id}`, { method:'DELETE', credentials:'include' }); if(!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error||`HTTP ${res.status}`);} await loadInbox(); alert('Talep başarıyla silindi'); }catch(err){ alert('Talep silinemedi: '+err.message);} return; }
    });

    // Priority change
    $('#list').addEventListener('change', async (e)=>{
      const sel = e.target.closest('.priority-select');
      if (!sel) return;
      const ticketId = sel.getAttribute('data-id');
      const newPriority = sel.value;
      try {
        const res = await fetch(`/tickets/${ticketId}/priority`, { method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ priority:newPriority }) });
        if (!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error||`HTTP ${res.status}`);} await loadInbox();
      } catch(err){ alert('Öncelik güncellenemedi: '+err.message); await loadInbox(); }
    });

    // Assign flow
    function bindAssignEvents(){
      $('#btnDoAssign').addEventListener('click', async ()=>{
        const userId = $('#assignUserSelect').value;
        if (!userId){ showAssignWarn('Lütfen bir kullanıcı seçin.'); return; }
        try{
          const res = await fetch(`/tickets/${selectedTicketId}/assign`, { method:'PUT', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ assigned_to:Number(userId) }) });
          if (!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error||`HTTP ${res.status}`);} bootstrap.Modal.getInstance('#assignModal')?.hide(); await loadInbox();
        }catch(err){ showAssignWarn('Atama başarısız: '+err.message); }
      });
    }
    function showAssignWarn(msg){ const el = $('#assignWarn'); el.textContent = msg; el.classList.remove('d-none'); }

    // Ticket selection + chat
    async function selectTicket(ticketId){
      try{
        const ticketRes = await fetch(`/tickets/${ticketId}`, { credentials:'include' });
        if (!ticketRes.ok) throw new Error('Talep bilgileri alınamadı');
        selectedTicket = await ticketRes.json();
        const messagesRes = await fetch(`/tickets/${ticketId}/messages`, { credentials:'include' });
        messages = messagesRes.ok ? await messagesRes.json() : [];
        updateChatUI();
        const chatPanel = $('#chatPanel'); chatPanel.style.display='block';
        setTimeout(()=>{ const ml = $('#messageList'); ml.scrollTop = ml.scrollHeight; }, 100);
      }catch(err){ alert('Talep açılamadı: '+err.message); }
    }

    function updateChatUI(){
      if (!selectedTicket) return;
      $('#chatTitle').textContent = `#${selectedTicket.id} - ${selectedTicket.subject || 'Konu yok'}`;
      $('#ticketSubject').textContent = selectedTicket.subject || 'Konu yok';
      $('#ticketDescription').textContent = selectedTicket.description || 'Açıklama yok';
      const st = $('#ticketStatus'); st.textContent = statusText(selectedTicket.status); st.className = `status-pill ${statusClass(selectedTicket.status)}`;
      const pr = $('#ticketPriority'); const p = selectedTicket.priority||'MEDIUM'; pr.textContent = p==='HIGH'?'Yüksek':p==='LOW'?'Düşük':'Orta'; pr.className = `priority-chip ${p==='HIGH'?'p-high':p==='LOW'?'p-low':'p-medium'}`;
      renderMessages();
    }

    function renderMessages(){
      const wrap = $('#messageList');
      if (!messages.length){ wrap.innerHTML = '<div class="text-center text-muted"><small>Henüz mesaj yok</small></div>'; return; }
      wrap.innerHTML = messages.map(m=>{
        const mine = m.sender_id === me.id;
        return `
          <div class="d-flex ${mine?'justify-content-end':'justify-content-start'} mb-3">
            <div class="bubble ${mine?'bubble-me':'bubble-other'}">
              <div class="small fw-semibold mb-1">${escapeHtml(m.sender_email || m.sender_name || 'Bilinmeyen')}</div>
              <div class="mb-1">${escapeHtml(m.content)}</div>
              <small class="${mine?'text-white-50':'text-muted'}">${new Date(m.created_at).toLocaleString('tr-TR')}</small>
            </div>
          </div>`;
      }).join('');
    }

    $('#sendMessage').addEventListener('click', sendMessage);
    $('#messageInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });

    async function sendMessage(){
      if (!selectedTicket) return;
      const input = $('#messageInput');
      const content = input.value.trim();
      if (!content) return;
      try{
        const res = await fetch(`/tickets/${selectedTicket.id}/messages`, { method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ content }) });
        if (!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error || `HTTP ${res.status}`); }
        const msg = await res.json();
        messages.push(msg); renderMessages(); input.value='';
        const ml = $('#messageList'); ml.scrollTop = ml.scrollHeight;
      }catch(err){ alert('Mesaj gönderilemedi: '+err.message); }
    }

    $('#closeChat').addEventListener('click', ()=>{ $('#chatPanel').style.display='none'; selectedTicket=null; messages=[]; });

  </script>
</body>
</html>
