<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Giriş</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body { background: #f8f9fa; }
    .login-card { max-width: 420px; width: 100%; }
    .brand { font-weight: 700; letter-spacing: .3px; }
    .logo-wrap { width: 56px; height: 56px; border-radius: 14px; display: inline-flex; align-items: center; justify-content: center; background: #e9f5ff; }
    .logo svg { width: 32px; height: 32px; }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100">
  <div class="card shadow-sm login-card">
    <div class="card-body p-4 p-md-5">

      <div class="text-center mb-4">
        <div class="d-inline-block logo-wrap mb-2">
          <span class="logo" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M4 5.5A3.5 3.5 0 0 1 7.5 2h9A3.5 3.5 0 0 1 20 5.5v6A3.5 3.5 0 0 1 16.5 15H11l-4.5 4v-4.5A3.5 3.5 0 0 1 4 11.5v-6Z" stroke="#0d6efd" stroke-width="1.6" />
              <path d="M9 9.75l1.8 1.8L15.3 7" stroke="#0d6efd" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </span>
        </div>
        <div class="brand fs-4" id="brand">HelpNest</div>
        <div class="text-muted">Hesabınızla giriş yapın</div>
      </div>

      <div id="alert" class="alert d-none" role="alert"></div>

      <form id="form" class="needs-validation" novalidate>
        <div class="mb-3">
          <label for="email" class="form-label">E-posta</label>
          <input type="email" class="form-control" id="email" placeholder="admin@local" value="admin@local" required />
          <div class="invalid-feedback">Lütfen geçerli bir e-posta girin.</div>
        </div>

        <div class="mb-3">
          <label for="password" class="form-label">Şifre</label>
          <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="••••••••" value="Admin123!" required />
            <button class="btn btn-outline-secondary" type="button" id="togglePwd" aria-label="Şifreyi göster/gizle">Göster</button>
          </div>
          <div class="invalid-feedback">Şifre gerekli.</div>
        </div>

        <div class="form-check mb-4">
          <input class="form-check-input" type="checkbox" id="remember" checked />
          <label class="form-check-label" for="remember">Beni hatırla</label>
        </div>

        <button id="btn" type="submit" class="btn btn-primary w-100">
          <span class="btn-text">Giriş Yap</span>
          <span class="spinner-border spinner-border-sm d-none ms-2" id="spinner" role="status" aria-hidden="true"></span>
        </button>
      </form>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const brandName = 'HelpNest';
    document.title = brandName + ' · Giriş';
    document.getElementById('brand').textContent = brandName;

    const form = document.getElementById('form');
    const alertBox = document.getElementById('alert');
    const btn = document.getElementById('btn');
    const spinner = document.getElementById('spinner');
    const btnText = document.querySelector('.btn-text');
    const togglePwd = document.getElementById('togglePwd');
    const pwdInput = document.getElementById('password');

    // Şifre göster/gizle
    togglePwd.addEventListener('click', () => {
      const isPw = pwdInput.type === 'password';
      pwdInput.type = isPw ? 'text' : 'password';
      togglePwd.textContent = isPw ? 'Gizle' : 'Göster';
      pwdInput.focus();
    });

    // Form submit → rol bazlı yönlendirme
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }
      setLoading(true);
      try {
        const body = {
          email: document.getElementById('email').value.trim(),
          password: pwdInput.value,
          remember: document.getElementById('remember').checked
        };

        const res = await fetch('/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(body)
        });

        const text = await res.text();
        let data; try { data = JSON.parse(text); } catch { data = { raw: text }; }

        if (res.ok) {
          if (data && data.user) {
            localStorage.setItem('helpdesk_user', JSON.stringify(data.user));
            // ⬇️ role göre sayfa
            if (data.user.role === 'end_user') {
              window.location.href = '/user.html';
            } else {
              window.location.href = '/dashboard.html';
            }
            return;
          }
          window.location.href = '/dashboard.html';
          return;
        } else {
          const msg = (data && (data.error || data.message)) || 'Giriş başarısız.';
          showAlert('danger', msg);
        }
      } catch (err) {
        showAlert('danger', 'Sunucuya ulaşılamıyor.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    });

    function setLoading(isLoading) {
      btn.disabled = isLoading;
      spinner.classList.toggle('d-none', !isLoading);
      btnText.textContent = isLoading ? 'Giriş yapılıyor...' : 'Giriş Yap';
    }
    function showAlert(type, message) {
      alertBox.className = `alert alert-${type}`;
      alertBox.textContent = message;
      alertBox.classList.remove('d-none');
    }
  </script>
</body>
</html>
