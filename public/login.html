<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Giriş</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/lux/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .auth-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1);
      overflow: hidden;
      width: 100%;
      max-width: 900px;
    }
    
    .auth-tabs {
      display: flex;
      border-bottom: 1px solid #eee;
    }
    
    .auth-tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      background: none;
      font-weight: 500;
    }
    
    .auth-tab.active {
      background: #f8f9fa;
      color: #007bff;
      border-bottom: 3px solid #007bff;
    }
    
    .auth-tab:hover:not(.active) {
      background: #f8f9fa;
    }
    
    .auth-content {
      padding: 40px;
    }
    
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .form-control {
      border-radius: 10px;
      border: 2px solid #e9ecef;
      padding: 12px 15px;
      transition: all 0.3s ease;
    }
    
    .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.25);
    }
    
    .btn-primary {
      border-radius: 10px;
      padding: 12px 30px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,123,255,0.4);
    }
    
    .alert {
      border-radius: 10px;
      border: none;
    }
  </style>
</head>
<body>
  <div class="auth-container">
    <!-- Tab Navigation -->
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="showTab('login')">Giriş Yap</button>
      <button class="auth-tab" onclick="showTab('register')">Kayıt Ol</button>
    </div>
    
    <!-- Login Form -->
    <div class="auth-content">
      <div id="loginForm" class="auth-form active">
        <h2 class="text-center mb-4">Giriş Yap</h2>
        <form id="loginFormElement">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">E-posta</label>
            <input type="email" class="form-control" id="loginEmail" required>
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Şifre</label>
            <input type="password" class="form-control" id="loginPassword" required>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Giriş Yap</button>
          </div>
        </form>
        <div id="loginAlert" class="alert mt-3 d-none"></div>
      </div>
      
      <!-- Register Form -->
      <div id="registerForm" class="auth-form">
        <h2 class="text-center mb-4">Kayıt Ol</h2>
        <form id="registerFormElement">
          <div class="mb-3">
            <label for="registerFullName" class="form-label">Ad Soyad</label>
            <input type="text" class="form-control" id="registerFullName" required>
          </div>
          <div class="mb-3">
            <label for="registerEmail" class="form-label">E-posta</label>
            <input type="email" class="form-control" id="registerEmail" required>
          </div>
          <div class="mb-3">
            <label for="registerPassword" class="form-label">Şifre</label>
            <input type="password" class="form-control" id="registerPassword" required minlength="6">
          </div>
          <div class="mb-3">
            <label for="registerPasswordConfirm" class="form-label">Şifre Tekrar</label>
            <input type="password" class="form-control" id="registerPasswordConfirm" required minlength="6">
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Kayıt Ol</button>
          </div>
        </form>
        <div id="registerAlert" class="alert mt-3 d-none"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Tab switching
    function showTab(tabName) {
      // Hide all forms
      document.querySelectorAll('.auth-form').forEach(form => {
        form.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.auth-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected form and activate tab
      document.getElementById(tabName + 'Form').classList.add('active');
      event.target.classList.add('active');
      
      // Clear alerts
      document.querySelectorAll('.alert').forEach(alert => {
        alert.classList.add('d-none');
      });
    }

    // Login form submission
    document.getElementById('loginFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const alertDiv = document.getElementById('loginAlert');
      
      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email, password })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Başarılı giriş
          alertDiv.className = 'alert alert-success mt-3';
          alertDiv.textContent = 'Giriş başarılı! Yönlendiriliyorsunuz...';
          alertDiv.classList.remove('d-none');
          
          // Kullanıcı bilgisini localStorage'a kaydet
          localStorage.setItem('helpdesk_user', JSON.stringify(data.user));
          
          // Rol bazlı yönlendirme
          setTimeout(() => {
            if (data.user.role === 'end_user') {
              window.location.href = '/user.html';
            } else if (data.user.role === 'dispatcher') {
              window.location.href = '/dispatcher.html';
            } else {
              window.location.href = '/dashboard.html';
            }
          }, 1500);
          
        } else {
          // Giriş hatası
          alertDiv.className = 'alert alert-danger mt-3';
          alertDiv.textContent = data.error || 'Giriş başarısız!';
          alertDiv.classList.remove('d-none');
        }
        
      } catch (error) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Bir hata oluştu: ' + error.message;
        alertDiv.classList.remove('d-none');
      }
    });

    // Register form submission
    document.getElementById('registerFormElement').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fullName = document.getElementById('registerFullName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
      const alertDiv = document.getElementById('registerAlert');
      
      // Şifre kontrolü
      if (password !== passwordConfirm) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Şifreler eşleşmiyor!';
        alertDiv.classList.remove('d-none');
        return;
      }
      
      // Şifre uzunluk kontrolü
      if (password.length < 6) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Şifre en az 6 karakter olmalıdır!';
        alertDiv.classList.remove('d-none');
        return;
      }
      
      try {
        const response = await fetch('/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            full_name: fullName, 
            email, 
            password 
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Başarılı kayıt
          alertDiv.className = 'alert alert-success mt-3';
          alertDiv.textContent = 'Kayıt başarılı! Giriş yapabilirsiniz.';
          alertDiv.classList.remove('d-none');
          
          // Formu temizle
          document.getElementById('registerFormElement').reset();
          
          // 3 saniye sonra giriş tabına geç
          setTimeout(() => {
            showTab('login');
          }, 3000);
          
        } else {
          // Kayıt hatası
          alertDiv.className = 'alert alert-danger mt-3';
          alertDiv.textContent = data.error || 'Kayıt başarısız!';
          alertDiv.classList.remove('d-none');
        }
        
      } catch (error) {
        alertDiv.className = 'alert alert-danger mt-3';
        alertDiv.textContent = 'Bir hata oluştu: ' + error.message;
        alertDiv.classList.remove('d-none');
      }
    });
  </script>
</body>
</html>
