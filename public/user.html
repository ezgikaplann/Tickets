<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Kullanıcı Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>.ticket-card .badge{letter-spacing:.3px}</style>
</head>
<body class="bg-light">
  <nav class="navbar bg-white border-bottom">
    <div class="container-fluid">
      <span class="navbar-brand">HelpNest · Kullanıcı Paneli</span>
      <div class="d-flex align-items-center gap-2">
        <!-- Talep oluşturma ayrı sayfada -->
        <a href="/new-ticket.html" class="btn btn-primary btn-sm">Talep Oluştur</a>
        <span class="small text-muted" id="userInfo"></span>
        <button id="btnLogout" class="btn btn-outline-secondary btn-sm">Çıkış</button>
      </div>
    </div>
  </nav>

  <main class="container py-4">

    <div class="mb-3">
      <input id="search" class="form-control" placeholder="Konu/açıklama ara (Enter)..." />
    </div>

    <!-- Tüm Talepler -->
    <section class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Tüm Talepler</h5>
        <small class="text-muted">Yeniler üstte</small>
      </div>
      <div id="list-all" class="vstack gap-2"></div>
      <div id="empty-all" class="text-muted d-none">Kayıt yok.</div>
    </section>

    <!-- Benim Taleplerim -->
    <section>
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">Benim Taleplerim</h5>
        <small class="text-muted">Yeniler üstte</small>
      </div>
      <div id="list-mine" class="vstack gap-2"></div>
      <div id="empty-mine" class="text-muted d-none">Henüz talebiniz yok.</div>
    </section>

  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    let me = null;
    let allTickets = [];

    // Oturum kontrolü
    (async () => {
      const r = await fetch('/auth/me', { credentials: 'include' });
      if (!r.ok) return window.location.href = '/login.html';
      me = (await r.json()).user;

      // admin/agent yanlışlıkla geldiyse dashboard'a
      if (me.role !== 'end_user') {
        window.location.href = '/dashboard.html';
        return;
      }

      $('#userInfo').textContent = `${me.full_name} • ${me.email}`;
      await loadLists();
    })();

    // Çıkış
    $('#btnLogout').addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch {}
      localStorage.removeItem('helpdesk_user');
      window.location.href = '/login.html';
    });

    // Arama (Enter)
    $('#search').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') await loadLists();
    });

    // API helper
    async function fetchTickets(params = {}) {
      const qs = new URLSearchParams(params).toString();
      const r = await fetch('/tickets' + (qs ? `?${qs}` : ''), { credentials: 'include' });
      if (!r.ok) throw new Error('tickets failed');
      return r.json();
    }

    // Listeleme
    async function loadLists() {
      const q = $('#search').value.trim();

      // Dashboard ile aynı: tüm talepler
      allTickets = await fetchTickets(q ? { q } : {});

      // Tüm Talepler - Basit öncelik sıralaması
      const allSorted = [...allTickets].sort((a, b) => {
        const priorityOrder = { 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
        
        const aPriority = a.priority || 'MEDIUM';
        const bPriority = b.priority || 'MEDIUM';
        
        return priorityOrder[aPriority] - priorityOrder[bPriority];
      });
      
      render('#list-all', '#empty-all', allSorted);

      // Benim Taleplerim - Basit öncelik sıralaması
      const mine = allTickets
        .filter(t => t.created_by === me.id)
        .sort((a, b) => {
          const priorityOrder = { 'HIGH': 1, 'MEDIUM': 2, 'LOW': 3 };
          
          const aPriority = a.priority || 'MEDIUM';
          const bPriority = b.priority || 'MEDIUM';
          
          return priorityOrder[aPriority] - priorityOrder[bPriority];
        });
      
      render('#list-mine', '#empty-mine', mine);
    }

    function render(listSel, emptySel, list) {
      const el = $(listSel), empty = $(emptySel);
      if (!list.length) { el.innerHTML = ''; empty.classList.remove('d-none'); return; }
      empty.classList.add('d-none');
      el.innerHTML = list.map(t => card(t)).join('');
    }

    function card(t) {
      return `
      <div class="card ticket-card">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <strong>${escapeHtml(t.subject || '(Konu yok)')}</strong>
            <span class="badge ${badgeClass(t.status)}">${t.status}</span>
          </div>
          <div class="small text-muted">
            #${t.id} • ${new Date(t.created_at).toLocaleString('tr-TR')} • Öncelik: ${t.priority}
          </div>
          <div class="small mt-2">${escapeHtml((t.description || '').slice(0,200))}</div>
        </div>
      </div>`;
    }

    function badgeClass(s) {
      switch (s) {
        case 'NEW': return 'bg-primary';
        case 'ASSIGNED': return 'bg-info';
        case 'RESOLVED': return 'bg-success';
        case 'CANCELLED': return 'bg-danger';
        case 'CLOSED': return 'bg-secondary';
        default: return 'bg-dark';
      }
    }
    function escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
  </script>
</body>
</html>
