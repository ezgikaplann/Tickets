<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>HelpNest · Kullanıcı Paneli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootswatch (Lux) + Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.2/dist/lux/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet" />
  <style>
    :root{
      --brand-1:#7A3DFC; /* violet */
      --brand-2:#00E5FF; /* cyan */
      --brand-3:#E429E8; /* magenta */
      --ink:#0f172a;     /* deep text */
      --muted:#64748b;   /* slate */
      --bg:#f7f8fc;      /* page bg */
      --card:#ffffff;    /* card bg */
    }
    html,body{height:100%}
    body{background: radial-gradient(1200px 600px at 10% -10%, rgba(122,61,252,.08), transparent 60%),
                     radial-gradient(900px 500px at 90% 10%, rgba(0,229,255,.10), transparent 60%),
                     radial-gradient(800px 400px at 40% 110%, rgba(228,41,232,.08), transparent 60%),
                     var(--bg)!important;}

    /* NAVBAR */
    .navbar{backdrop-filter:saturate(150%) blur(8px); background:rgba(255,255,255,.7)!important; border-bottom:1px solid #e9edf5!important}
    .navbar-brand{font-weight:700; letter-spacing:.2px;}

    /* HEADER RIBBON */
    .ribbon{border-radius:20px; border:1px solid rgba(0,0,0,.05); background:linear-gradient(135deg, rgba(122,61,252,.12), rgba(0,229,255,.12));}

    /* CARDS */
    .ticket-card{background:var(--card); border:1px solid #e9edf5; border-left:6px solid transparent; box-shadow:0 10px 30px rgba(2,6,23,.05); transition:transform .18s ease, box-shadow .18s ease}
    .ticket-card:hover{transform:translateY(-3px); box-shadow:0 18px 40px rgba(2,6,23,.08)}
    .ticket-card .subject{color:var(--ink); font-weight:600}
    .ticket-card .excerpt{color:#475569}

    /* STATUS + PRIORITY */
    .status-pill{font-weight:600; padding:.35rem .6rem; border-radius:999px; border:1px solid #e2e8f0}
    .s-new{background:#eef2ff; color:#4338ca; border-color:#c7d2fe}
    .s-assigned{background:#ecfeff; color:#0e7490; border-color:#a5f3fc}
    .s-resolved{background:#ecfdf5; color:#047857; border-color:#a7f3d0}
    .s-cancelled{background:#fff1f2; color:#be123c; border-color:#fecdd3}
    .s-closed{background:#f1f5f9; color:#334155; border-color:#e2e8f0}

    .priority-chip{padding:.2rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700}
    .p-low{background:#f1f5f9; color:#334155}
    .p-medium{background:#fef3c7; color:#92400e}
    .p-high{background:#fee2e2; color:#991b1b}

    /* SEARCH */
    .search-wrap{position:relative}
    .search-wrap .bi{position:absolute; left:.75rem; top:50%; transform:translateY(-50%); color:#94a3b8}
    .search-wrap input{padding-left:2.2rem}

    /* OFFCANVAS / CHAT */
    .offcanvas{--bs-offcanvas-width:min(560px,100vw)}
    .message-list{height: 56vh; overflow-y:auto; padding-right:.25rem}
    .bubble{max-width:78%; padding:.6rem .75rem; border-radius:16px; box-shadow:0 8px 20px rgba(2,6,23,.08)}
    .bubble-me{margin-left:auto; background:linear-gradient(135deg, var(--brand-1), var(--brand-2)); color:#fff}
    .bubble-other{background:#f8fafc; color:#0f172a; border:1px solid #e2e8f0}
    .bubble small{opacity:.8}

    /* SKELETON */
    .skeleton{position:relative; overflow:hidden; background:#eef2f7; border-radius:12px}
    .skeleton::after{content:""; position:absolute; inset:0; transform:translateX(-100%); background:linear-gradient(90deg, transparent, rgba(255,255,255,.5), transparent); animation:shimmer 1.2s infinite}
    @keyframes shimmer{100%{transform:translateX(100%)}}
  </style>
</head>
<body>
  <nav class="navbar sticky-top">
    <div class="container-xxl">
      <a class="navbar-brand" href="#">HelpNest</a>
      <div class="d-flex align-items-center gap-2">
        <a href="/new-ticket.html" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg me-1"></i>Talep Oluştur</a>
        <span class="small text-muted" id="userInfo"></span>
        <button id="btnLogout" class="btn btn-outline-secondary btn-sm">Çıkış</button>
      </div>
    </div>
  </nav>

  <main class="container-xxl py-4">
    <!-- Header / Filters -->
    <div class="ribbon p-3 p-md-4 mb-4">
      <div class="row g-3 align-items-end">
        <div class="col-12 col-lg-4">
          <h2 class="h4 mb-1">Taleplerim</h2>
          <div class="text-muted small">Durumunuzu takip edin, filtreleyin ve sohbet edin.</div>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Kategori</label>
          <select id="categorySelect" class="form-select">
            <option value="">Tüm Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Alt Kategori</label>
          <select id="subcategorySelect" class="form-select">
            <option value="">Tüm Alt Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-md-4 col-lg-2">
          <label class="form-label mb-1">Alt-Alt Kategori</label>
          <select id="subsubcategorySelect" class="form-select">
            <option value="">Tüm Alt-Alt Kategoriler</option>
          </select>
        </div>
        <div class="col-12 col-lg-2">
          <label class="form-label mb-1">Ara</label>
          <div class="search-wrap">
            <i class="bi bi-search"></i>
            <input id="search" class="form-control" placeholder="Konu / açıklama ara..." />
          </div>
        </div>
      </div>
    </div>

    <!-- Ticket Grid -->
    <div id="ticketGrid" class="row g-3"></div>
    <div id="emptyState" class="d-none text-center text-muted py-5">
      <svg width="72" height="72" viewBox="0 0 24 24" fill="none" class="mb-2" xmlns="http://www.w3.org/2000/svg"><path d="M20 7H4v10h16V7Zm-5 7H9" stroke="#94a3b8" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 7V5a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2" stroke="#94a3b8" stroke-width="1.5"/></svg>
      <div>Hiç talep bulunamadı.</div>
    </div>
  </main>

  <!-- Chat Offcanvas -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="chatOffcanvas" aria-labelledby="chatLabel">
    <div class="offcanvas-header border-bottom">
      <div>
        <h5 id="chatLabel" class="mb-0">Talep Detayı</h5>
        <div class="small text-muted" id="chatMeta"></div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Kapat"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column p-0">
        <div class="p-3 border-bottom">
        <h6 id="ticketSubject" class="mb-1">Konu</h6>
        <div class="small text-muted mb-2" id="ticketDescription">Açıklama</div>
        <div class="d-flex flex-wrap gap-2">
          <span id="ticketStatus" class="status-pill s-new">Yeni</span>
          <span id="ticketPriority" class="priority-chip p-medium">Orta</span>
        </div>
          </div>
      <div id="messageList" class="message-list p-3">
        <div class="text-center text-muted"><small>Mesaj yükleniyor…</small></div>
        </div>
        <div class="p-3 border-top">
          <div class="input-group">
          <input type="text" class="form-control" id="messageInput" placeholder="Mesaj yazın…" />
          <button class="btn btn-primary" type="button" id="sendMessage"><i class="bi bi-send"></i></button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    let me = null;
    let allTickets = [];
    let categories = [];
    let subcategories = [];
    let subsubcategories = [];

    // Skeleton helpers
    function showSkeletonCards(n=6){
      const grid = $('#ticketGrid');
      grid.innerHTML = Array.from({length:n}).map(()=>`
        <div class="col-12 col-md-6 col-lg-4">
          <div class="p-3 skeleton" style="height:130px"></div>
        </div>
      `).join('');
      $('#emptyState').classList.add('d-none');
    }

    // Init session
    (async () => {
      showSkeletonCards(6);
      const r = await fetch('/auth/me', { credentials: 'include' });
      if (!r.ok) return window.location.href = '/login.html';
      me = (await r.json()).user;
      if (me.role !== 'end_user') { window.location.href = '/dashboard.html'; return; }
      $('#userInfo').textContent = `${me.full_name} • ${me.email}`;

      await loadCategories();
      await loadSubcategories('');
      await loadSubsubcategories('');
      await loadLists();
    })();

    // Logout
    $('#btnLogout').addEventListener('click', async () => {
      try { await fetch('/auth/logout', { method: 'POST', credentials: 'include' }); } catch {}
      localStorage.removeItem('helpdesk_user');
      window.location.href = '/login.html';
    });

    // Search (debounce)
    let searchTimeout;
    $('#search').addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(loadLists, 300);
    });

    // Enter to search immediately
    $('#search').addEventListener('keydown', async (e) => {
      if (e.key === 'Enter') { clearTimeout(searchTimeout); await loadLists(); }
    });

    async function fetchTickets(params = {}) {
      const qs = new URLSearchParams(params).toString();
      const r = await fetch('/tickets' + (qs ? `?${qs}` : ''), { credentials: 'include' });
      if (!r.ok) throw new Error('tickets failed');
      return r.json();
    }

    async function loadLists(){
      showSkeletonCards(6);
      const q = $('#search').value.trim();
      const categoryId = $('#categorySelect').value;
      const subcategoryId = $('#subcategorySelect').value;
      const subsubcategoryId = $('#subsubcategorySelect').value;
      
      const params = {};
      if (q) params.q = q;
      if (categoryId) params.category_id = categoryId;
      if (subcategoryId) params.subcategory_id = subcategoryId;
      if (subsubcategoryId) params.sub_subcategory_id = subsubcategoryId;

      allTickets = await fetchTickets(params);
      // simple priority sort
      const weight = { HIGH: 1, MEDIUM: 2, LOW: 3 };
      const sorted = [...allTickets].sort((a,b)=> (weight[a?.priority||'MEDIUM'] - weight[b?.priority||'MEDIUM']));
      renderTickets(sorted);
    }

    function renderTickets(list){
      const grid = $('#ticketGrid');
      if (!list.length){ grid.innerHTML = ''; $('#emptyState').classList.remove('d-none'); return; }
      $('#emptyState').classList.add('d-none');
      grid.innerHTML = list.map(t=>ticketCard(t)).join('');
    }

    function statusClass(s){
      switch (s){
        case 'NEW': return 's-new';
        case 'ASSIGNED': return 's-assigned';
        case 'RESOLVED': return 's-resolved';
        case 'CANCELLED': return 's-cancelled';
        case 'CLOSED': return 's-closed';
        default: return 's-closed';
      }
    }

    function statusText(s){
      return ({ NEW:'Yeni', ASSIGNED:'Atandı', RESOLVED:'Çözüldü', CANCELLED:'İptal', CLOSED:'Kapalı' }[s] || s);
    }

    function priorityChip(p){
      const cls = p==='HIGH' ? 'p-high' : p==='LOW' ? 'p-low' : 'p-medium';
      const text = p==='HIGH' ? 'Yüksek' : p==='LOW' ? 'Düşük' : 'Orta';
      return `<span class="priority-chip ${cls}">${text}</span>`
    }

    function cardBorder(s){
      return ({ NEW:'#7A3DFC', ASSIGNED:'#00B8D9', RESOLVED:'#22C55E', CANCELLED:'#EF4444', CLOSED:'#94A3B8' }[s] || '#94A3B8');
    }

    function ticketCard(t){
      const created = new Date(t.created_at).toLocaleString('tr-TR');
      const border = cardBorder(t.status);
      return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="ticket-card p-3 rounded-3" style="border-left-color:${border}" role="button" onclick="selectTicket(${Number(t.id)})">
          <div class="d-flex justify-content-between align-items-start">
            <div class="subject">${escapeHtml(t.subject||'(Konu yok)')}</div>
            <span class="status-pill ${statusClass(t.status)}">${statusText(t.status)}</span>
          </div>
          <div class="small text-muted mt-1">#${t.id} • ${created} • ${priorityChip(t.priority)}</div>
          <div class="excerpt small mt-2">${escapeHtml((t.description||'').slice(0,200))}</div>
        </div>
      </div>`;
    }

    // =============== CHAT ===============
    let selectedTicket = null;
    let messages = [];

    async function selectTicket(ticketId){
      try{
        const rTicket = await fetch(`/tickets/${ticketId}`, { credentials: 'include' });
        if (!rTicket.ok) throw new Error('Talep bilgileri alınamadı');
        selectedTicket = await rTicket.json();

        const rMsg = await fetch(`/tickets/${ticketId}/messages`, { credentials: 'include' });
        messages = rMsg.ok ? await rMsg.json() : [];

        updateChatUI();
        bootstrap.Offcanvas.getOrCreateInstance($('#chatOffcanvas')).show();
        // scroll bottom
        setTimeout(()=>{ const ml=$('#messageList'); ml.scrollTop=ml.scrollHeight; }, 100);
      }catch(err){
        console.error(err); alert('Talep açılamadı: '+ err.message);
      }
    }

    function updateChatUI(){
      if (!selectedTicket) return;
      $('#chatLabel').textContent = `#${selectedTicket.id} - ${selectedTicket.subject || 'Konu yok'}`;
      $('#chatMeta').textContent = new Date(selectedTicket.created_at).toLocaleString('tr-TR');
      $('#ticketSubject').textContent = selectedTicket.subject || 'Konu yok';
      $('#ticketDescription').textContent = selectedTicket.description || 'Açıklama yok';
      const st = $('#ticketStatus'); st.textContent = statusText(selectedTicket.status); st.className = `status-pill ${statusClass(selectedTicket.status)}`;
      const pr = $('#ticketPriority'); pr.textContent = (selectedTicket.priority||'MEDIUM').replace('LOW','Düşük').replace('MEDIUM','Orta').replace('HIGH','Yüksek');
      pr.className = `priority-chip ${ (selectedTicket.priority==='HIGH'?'p-high':selectedTicket.priority==='LOW'?'p-low':'p-medium') }`;
      renderMessages();
    }

    function renderMessages(){
      const wrap = $('#messageList');
      if (!messages.length){ wrap.innerHTML = '<div class="text-center text-muted"><small>Henüz mesaj yok</small></div>'; return; }
      wrap.innerHTML = messages.map(m=>{
        const mine = m.sender_id === me.id;
        return `
          <div class="d-flex ${mine?'justify-content-end':'justify-content-start'} mb-3">
            <div class="bubble ${mine?'bubble-me':'bubble-other'}">
              <div class="small fw-semibold mb-1">${escapeHtml(m.sender_email || m.sender_name || 'Bilinmeyen')}</div>
              <div class="mb-1">${escapeHtml(m.content)}</div>
              <small class="text-white-50">${new Date(m.created_at).toLocaleString('tr-TR')}</small>
            </div>
          </div>`;
      }).join('');
    }

    $('#sendMessage').addEventListener('click', sendMessage);
    $('#messageInput').addEventListener('keypress', (e)=>{ if(e.key==='Enter') sendMessage(); });

    async function sendMessage(){
      if (!selectedTicket) return;
      const input = $('#messageInput');
      const content = input.value.trim();
      if (!content) return;
      try{
        const res = await fetch(`/tickets/${selectedTicket.id}/messages`, {
          method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include', body:JSON.stringify({ content })
        });
        if (!res.ok){ const err = await res.json().catch(()=>({})); throw new Error(err.error || `HTTP ${res.status}`); }
        const msg = await res.json();
        messages.push(msg);
        renderMessages(); input.value='';
        const ml = $('#messageList'); ml.scrollTop = ml.scrollHeight;
      }catch(err){ console.error(err); alert('Mesaj gönderilemedi: '+err.message); }
    }

    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}

    // ===== Categories =====
    async function loadCategories(){
      try{
        const res = await fetch('/tickets/categories', { credentials: 'include' });
        if (res.ok){
          categories = await res.json();
          $('#categorySelect').innerHTML = '<option value="">Tüm Kategoriler</option>' + categories.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
        }
      }catch(e){ console.error('Kategoriler yüklenemedi:', e); }
    }

    // Alt kategorileri yükle
    async function loadSubcategories(categoryId) {
      try {
        if (!categoryId) {
          $('#subcategorySelect').innerHTML = '<option value="">Tüm Alt Kategoriler</option>';
          $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
          return;
        }
        
        console.log('Alt kategoriler yükleniyor, category_id:', categoryId);
        
        const res = await fetch(`/tickets/subcategories?category_id=${categoryId}`, { credentials: 'include' });
        if (res.ok) {
          subcategories = await res.json();
          console.log('Alt kategoriler yüklendi:', subcategories);
          
          $('#subcategorySelect').innerHTML = '<option value="">Tüm Alt Kategoriler</option>' + 
            subcategories.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
        } else {
          console.error('Alt kategoriler yüklenemedi:', res.status);
          $('#subcategorySelect').innerHTML = '<option value="">Alt kategoriler yüklenemedi</option>';
        }
        
        // Alt kategori değiştiğinde alt-alt kategorileri temizle
        $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
      } catch (err) {
        console.error('Alt kategoriler yüklenemedi:', err);
        $('#subcategorySelect').innerHTML = '<option value="">Hata oluştu</option>';
      }
    }

    // Alt-alt kategorileri yükle
    async function loadSubsubcategories(subcategoryId) {
      try {
        if (!subcategoryId) {
          console.log('subcategoryId boş, alt-alt kategoriler temizleniyor');
          $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
          return;
        }
        
        console.log('=== ALT-ALT KATEGORİLER YÜKLENİYOR ===');
        console.log('subcategoryId:', subcategoryId);
        console.log('subcategoryId type:', typeof subcategoryId);
        
        const url = `/tickets/subsubcategories?subcategory_id=${subcategoryId}`;
        console.log('API URL:', url);
        
        const res = await fetch(url, { credentials: 'include' });
        console.log('API Response status:', res.status);
        console.log('API Response ok:', res.ok);
        
        if (res.ok) {
          const data = await res.json();
          console.log('API Response data:', data);
          console.log('Data type:', typeof data);
          console.log('Data length:', Array.isArray(data) ? data.length : 'Not an array');
          
          subsubcategories = data;
          
          if (Array.isArray(data) && data.length > 0) {
            const options = '<option value="">Tüm Alt-Alt Kategoriler</option>' + 
              data.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join('');
            
            console.log('Generated options HTML:', options);
            $('#subsubcategorySelect').innerHTML = options;
            
            console.log('Alt-alt kategoriler başarıyla yüklendi:', data.length, 'adet');
          } else {
            console.log('Alt-alt kategori verisi boş veya array değil');
            $('#subsubcategorySelect').innerHTML = '<option value="">Alt-alt kategori bulunamadı</option>';
          }
        } else {
          const errorText = await res.text();
          console.error('API Error Response:', errorText);
          
          try {
            const errorJson = JSON.parse(errorText);
            console.error('Parsed Error:', errorJson);
          } catch (parseError) {
            console.error('Error response parse edilemedi:', parseError);
          }
          
          $('#subsubcategorySelect').innerHTML = '<option value="">Alt-alt kategoriler yüklenemedi</option>';
        }
      } catch (err) {
        console.error('=== ALT-ALT KATEGORİLER YÜKLEME HATASI ===');
        console.error('Error details:', err);
        console.error('Error message:', err.message);
        console.error('Error stack:', err.stack);
        
        $('#subsubcategorySelect').innerHTML = '<option value="">Hata oluştu</option>';
      }
    }

    // Listeners for filters
    $('#categorySelect').addEventListener('change', async (e)=>{
      const categoryId = e.target.value;
      console.log('Ana kategori değişti:', categoryId);
      
      if (categoryId) {
        console.log('Alt kategoriler yükleniyor...');
      await loadSubcategories(categoryId);
      } else {
        console.log('Ana kategori seçimi temizlendi, alt kategoriler temizleniyor...');
        $('#subcategorySelect').innerHTML = '<option value="">Tüm Alt Kategoriler</option>';
        $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
      }
      
      await loadLists(); // Arama ve filtreleme yapılınca listeyi yeniden yükle
    });

    $('#subcategorySelect').addEventListener('change', async (e) => {
      const subcategoryId = e.target.value;
      console.log('Alt kategori değişti:', subcategoryId);
      
      if (subcategoryId) {
        console.log('Alt-alt kategoriler yükleniyor...');
      await loadSubsubcategories(subcategoryId);
      } else {
        console.log('Alt kategori seçimi temizlendi, alt-alt kategoriler temizleniyor...');
        $('#subsubcategorySelect').innerHTML = '<option value="">Tüm Alt-Alt Kategoriler</option>';
      }
      
      await loadLists(); // Arama ve filtreleme yapılınca listeyi yeniden yükle
    });

    $('#subsubcategorySelect').addEventListener('change', async () => {
      console.log('Alt-alt kategori değişti, liste yenileniyor...');
      await loadLists(); // Arama ve filtreleme yapılınca listeyi yeniden yükle
    });
  </script>
</body>
</html>
